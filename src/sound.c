/*
 * sound.c
 *
 *  Created on: 11 февр. 2017 г.
 *      Author: se
 */

#include "stm32f0xx.h"
#include "main.h"
#include "sound.h"

//===========================================================================
//===========================================================================
static uint8_t ev = 0;

/*
 * помещает событие в буфер
 * return 1 - успешно; 0 - нет места в буфере
 */
int sndPutEv(uint8_t event) {
	ev = event;
	return 1;
}
/*
 *  извлекает событие из буфера
 *  если 0 - нет событий
 */
uint8_t sndGetEv(void) {
	uint8_t res;
	res = ev;
	ev = 0;
	return res;
}
//===========================================================================
//===========================================================================

/* converted rtttl melody to convenient for cpu image */

typedef struct {
    uint16_t period;
    uint16_t delay;
} melody_t;

typedef struct {
    char*     name;
    melody_t  mel[];
} srec_t;

srec_t r_Peek = { .name = "Peek", .mel = {
  {1432, 124},{1432, 124},{1432, 124},{   0,   0}}
};
srec_t r_XFiles = { .name = "XFiles", .mel = {
  {1517, 480},{1012, 480},{1136, 480},{1012, 480},{ 851, 480},{1012,1440},{   0,1920},
  {   0,   0}}
};
srec_t r_Eternally = { .name = "Eternally", .mel = {
  {1012, 532},{1012, 264},{1136, 264},{1012, 264},{ 955, 264},{1136, 532},{1136, 264},
  {1275, 264},{1136, 264},{1012, 264},{1275, 532},{1275, 264},{1351, 264},{1517, 264},
  {1607, 264},{1517,1068},{   0,   0}}
};
srec_t r_Batman = { .name = "Batman", .mel = {
  {1136,  92},{1204,  92},{1275,  92},{1351,  92},{1432,  92},{1351,  92},{1275,  92},
  {1204,  92},{1136, 558},{   0,   0}}
};
srec_t r_Simpsons = { .name = "Simpsons", .mel = {
  { 955, 558},{ 758, 372},{ 675, 372},{ 568, 184},{ 637, 558},{ 758, 372},{ 955, 372},
  {1136, 184},{1351, 184},{1351, 184},{1351, 184},{1275, 748},{   0,   0}}
};
srec_t r_TheSimpsons = { .name = "TheSimpsons", .mel = {
  { 955, 558},{ 758, 372},{ 675, 372},{ 568, 184},{ 637, 558},{ 758, 372},{ 955, 372},
  {1136, 184},{1351, 184},{1351, 184},{1351, 184},{1275, 748},{   0, 184},{   0, 184},
  {1351, 184},{1351, 184},{1351, 184},{1275, 184},{1072, 558},{ 955, 184},{ 955, 184},
  { 955, 184},{ 955, 372},{   0,   0}}
};
srec_t r_DasBoot = { .name = "DasBoot", .mel = {
  {3215, 900},{3401, 300},{3816, 300},{3401, 300},{3215, 300},{2551, 300},{2145, 900},
  {2272, 300},{2551, 300},{2272, 300},{2145, 300},{1703, 300},{1432,1800},{   0, 600},
  {2865, 900},{3030, 300},{3401, 300},{3030, 300},{2865, 300},{2272, 300},{1912, 900},
  {2024, 300},{2272, 300},{2024, 300},{1912, 300},{1517, 300},{1275,1800},{   0,1200},
  {   0,   0}}
};
srec_t r_TakeOnMe = { .name = "TakeOnMe", .mel = {
  {1351, 184},{1351, 184},{1351, 184},{1703, 184},{   0, 184},{2024, 184},{   0, 184},
  {1517, 184},{   0, 184},{1517, 184},{   0, 184},{1517, 184},{1204, 184},{1204, 184},
  {1136, 184},{1012, 184},{1136, 184},{1136, 184},{1136, 184},{1517, 184},{   0, 184},
  {1703, 184},{   0, 184},{1351, 184},{   0, 184},{1351, 184},{   0, 184},{1351, 184},
  {1517, 184},{1517, 184},{1351, 184},{1517, 184},{1351, 184},{1351, 184},{1351, 184},
  {1703, 184},{   0, 184},{2024, 184},{   0, 184},{1517, 184},{   0, 184},{1517, 184},
  {   0, 184},{1517, 184},{1204, 184},{1204, 184},{1136, 184},{1012, 184},{1136, 184},
  {1136, 184},{1136, 184},{1517, 184},{   0, 184},{1703, 184},{   0, 184},{1351, 184},
  {   0, 184},{1351, 184},{   0, 184},{1351, 184},{1517, 184},{1517, 184},
  {   0,   0}}
};
srec_t r_MissionImp = { .name = "MissionImp", .mel = {
  {1703, 100},{1607, 100},{1703, 100},{1607, 100},{1703, 100},{1607, 100},{1703, 100},
  {1703, 100},{1607, 100},{1517, 100},{1432, 100},{1351, 100},{1275, 100},{1275, 200},
  {   0, 400},{1275, 200},{   0, 400},{1072, 200},{   0, 200},{ 955, 200},{   0, 200},
  {1275, 200},{   0, 400},{1275, 200},{   0, 400},{1432, 200},{   0, 200},{   0, 200},
  {1275, 200},{   0, 400},{   0, 400},{1072, 200},{   0, 200},{ 955, 200},{   0, 200},
  {1275, 200},{   0, 400},{   0, 400},{1432, 200},{   0, 200},{1351, 200},{   0, 200},
  {1072, 200},{1275, 200},{1703,1600},{   0,   0}}
};
srec_t r_Et = { .name = "Et", .mel = {
  { 851, 600},{ 568, 600},{ 637, 148},{ 675, 148},{ 758, 148},{ 675, 148},{ 851, 600},
  {1136,1200},{1012, 600},{ 506, 600},{ 568, 148},{ 602, 148},{ 675, 148},{ 602, 148},
  { 758, 600},{ 450,1200},{ 758, 600},{ 425, 600},{ 450, 148},{ 506, 148},{ 568, 148},
  { 637, 148},{ 715, 600},{ 851, 900},{ 851,  72},{ 901,  72},{ 851,  72},{ 758,  72},
  { 715, 600},{ 851, 600},{ 425, 600},{ 450,1200},{   0,   0}}
};
srec_t r_Axelf = { .name = "Axelf", .mel = {
  {1351, 372},{1136, 276},{1351, 184},{1351,  92},{1072, 184},{1351, 184},{1517, 184},
  {1351, 372},{ 955, 276},{1351, 184},{1351,  92},{ 851, 184},{ 901, 184},{1136, 184},
  {1351, 184},{ 901, 184},{ 675, 184},{1351,  92},{1517, 184},{1517,  92},{1805, 184},
  {1204, 184},{1351, 558},{   0,   0}}
};
srec_t r_Hogans = { .name = "Hogans", .mel = {
  {1432, 498},{1204, 498},{ 901, 498},{ 715, 498},{ 675, 332},{ 602, 164},{ 675, 246},
  { 715, 246},{ 803, 996},{ 675, 332},{ 602, 164},{ 675, 246},{ 715, 246},{ 803, 498},
  {1204, 498},{ 901, 332},{ 955, 164},{ 901, 246},{1072, 246},{1204, 996},{1432, 498},
  {1204, 498},{ 901, 498},{1432, 498},{1351, 246},{1072, 498},{1351, 246},{ 803, 498},
  { 675, 498},{ 715, 246},{ 602, 498},{ 715, 246},{ 901, 498},{ 803, 498},{ 901, 996},
  {   0,   0}}
};
srec_t r_PinkPanther = { .name = "PinkPanther", .mel = {
  {1607, 184},{1517, 184},{   0, 748},{1351, 184},{1275, 184},{   0, 748},{1607, 184},
  {1517, 184},{   0,  92},{1351, 184},{1275, 184},{   0,  92},{ 955, 184},{1012, 184},
  {   0,  92},{1607, 184},{1517, 184},{   0,  92},{1012, 184},{1072, 748},{   0, 748},
  {1136,  92},{1275,  92},{1517,  92},{1703,  92},{1517, 748},{   0,   0}}
};
srec_t r_CountDown = { .name = "CountDown", .mel = {
  {   0, 480},{   0, 240},{1012, 120},{1136, 120},{1012, 480},{1517, 480},{   0, 480},
  {   0, 240},{ 955, 120},{1012, 120},{ 955, 240},{1012, 240},{1136, 480},{   0, 480},
  {   0, 240},{ 955, 120},{1012, 120},{ 955, 480},{1517, 480},{   0, 480},{   0, 240},
  {1136, 120},{1275, 120},{1136, 240},{1275, 240},{1351, 240},{1136, 240},{1275, 720},
  {1351, 120},{1275, 120},{1136, 720},{1275, 120},{1136, 120},{1012, 240},{1136, 240},
  {1275, 240},{1351, 240},{1517, 480},{ 955, 480},{1012,1440},{1012, 120},{ 955, 120},
  {1012, 120},{1136, 120},{1012,1920},{   0,   0}}
};
srec_t r_AdamsFamily = { .name = "AdamsFamily", .mel = {
  {1912, 184},{1432, 372},{1136, 184},{1432, 372},{1912, 184},{2024, 372},{1275, 748},
  {1432, 184},{1517, 372},{1275, 184},{1517, 372},{3030, 184},{2272, 372},{1432, 748},
  {1912, 184},{1432, 372},{1136, 184},{1432, 372},{1912, 184},{2024, 372},{1275, 748},
  {1432, 184},{1517, 372},{1912, 184},{1703, 372},{1517, 184},{1432,1500},{1912, 184},
  {1703, 184},{1517, 184},{1432, 184},{   0,1500},{1703, 184},{1517, 184},{1351, 184},
  {1275, 184},{   0,1500},{1703, 184},{1517, 184},{1351, 184},{1275, 184},{   0, 372},
  {1703, 184},{1517, 184},{1351, 184},{1275, 184},{   0, 372},{1912, 184},{1703, 184},
  {1517, 184},{1432, 184},{   0,   0}}
};
srec_t r_Indiana = { .name = "Indiana", .mel = {
  {1517, 240},{   0, 120},{1432, 120},{1275, 120},{   0, 120},{ 955, 960},{   0, 180},
  {1703, 240},{   0, 120},{1517, 120},{1432, 960},{   0, 360},{1275, 240},{   0, 120},
  {1136, 120},{1012, 120},{   0, 120},{ 715, 960},{   0, 240},{1136, 240},{   0, 120},
  {1012, 120},{ 955, 480},{ 851, 480},{ 758, 480},{1517, 240},{   0, 120},{1432, 120},
  {1275, 120},{   0, 120},{ 955, 960},{   0, 240},{ 851, 240},{   0, 120},{ 758, 120},
  { 715,1440},{1275, 240},{   0, 120},{1275, 120},{ 758, 360},{   0, 120},{ 851, 240},
  {   0, 120},{1275, 120},{ 758, 360},{   0, 120},{ 851, 240},{   0, 120},{1275, 120},
  { 715, 360},{   0, 120},{ 758, 240},{   0, 120},{ 851, 120},{ 955, 480},
  {   0,   0}}
};
srec_t r_BarbieGirl = { .name = "BarbieGirl", .mel = {
  {1204, 240},{1517, 240},{1204, 240},{ 901, 240},{1136, 480},{   0, 480},{1351, 240},
  {1607, 240},{1351, 240},{1012, 240},{1204, 480},{1351, 240},{1517, 240},{   0, 480},
  {1517, 240},{1805, 240},{1351, 480},{1805, 480},{   0, 480},{1351, 240},{1517, 240},
  {1204, 480},{1351, 480},{   0,   0}}
};
srec_t r_Entertainer = { .name = "Entertainer", .mel = {
  {1703, 212},{1607, 212},{1517, 212},{ 955, 428},{1517, 212},{ 955, 428},{1517, 212},
  { 955,1284},{ 955, 212},{ 851, 212},{ 803, 212},{ 758, 212},{ 955, 212},{ 851, 212},
  { 758, 428},{1012, 212},{ 851, 428},{ 955, 856},{   0, 428},{1703, 212},{1607, 212},
  {1517, 212},{ 955, 428},{1517, 212},{ 955, 428},{1517, 212},{ 955,1284},{   0, 212},
  {1136, 212},{1275, 212},{1351, 212},{1136, 212},{ 955, 212},{ 758, 428},{ 851, 212},
  { 955, 212},{1136, 212},{ 851, 856},{   0,   0}}
};
srec_t r_Autumn = { .name = "Autumn", .mel = {
  { 568, 240},{ 568, 240},{ 568, 240},{ 536, 240},{ 568, 480},{ 568, 240},{ 536, 240},
  { 568, 240},{ 568, 240},{ 568, 240},{ 536, 240},{ 568, 480},{ 568, 240},{ 536, 240},
  { 568, 240},{ 637, 120},{ 568, 120},{ 536, 240},{ 568, 240},{ 637, 360},{   0, 120},
  { 568, 240},{ 568, 240},{ 568, 240},{ 536, 240},{ 568, 480},{ 568, 240},{ 536, 240},
  { 568, 240},{ 568, 240},{ 568, 240},{ 536, 240},{ 568, 480},{ 568, 240},{ 536, 240},
  { 568, 240},{ 637, 120},{ 568, 120},{ 536, 240},{ 568, 240},{ 637, 360},
  {   0,   0}}
};
srec_t r_Spring = { .name = "Spring", .mel = {
  { 758, 240},{ 602, 240},{ 602, 240},{ 602, 240},{ 675, 120},{ 758, 120},{ 506, 720},
  { 506, 120},{ 568, 120},{ 602, 240},{ 602, 240},{ 602, 240},{ 675, 120},{ 758, 120},
  { 506, 720},{ 506, 120},{ 568, 120},{ 602, 240},{ 568, 120},{ 506, 120},{ 568, 240},
  { 602, 240},{ 675, 240},{ 803, 240},{ 506, 720},{ 758, 240},{ 602, 240},{ 602, 240},
  { 602, 240},{ 675, 120},{ 758, 120},{ 506, 720},{ 506, 120},{ 568, 120},{ 602, 240},
  { 602, 240},{ 602, 240},{ 675, 120},{ 758, 120},{ 506, 720},{ 506, 120},{ 568, 120},
  { 602, 240},{ 568, 120},{ 506, 120},{ 568, 240},{ 602, 240},{ 675, 240},{ 803, 240},
  { 506, 720},{   0,   0}}
};
srec_t r_Gadget = { .name = "Gadget", .mel = {
  {1607, 148},{1432, 148},{1351, 148},{1204, 148},{1072, 300},{1351, 300},{1136, 300},
  {1432, 300},{1204, 300},{1351, 300},{1607, 148},{1432, 148},{1351, 148},{1204, 148},
  {1072, 300},{ 803, 300},{ 851,1200},{1607, 148},{1432, 148},{1351, 148},{1204, 148},
  {1072, 300},{1351, 300},{1136, 300},{1432, 300},{1204, 300},{1351, 300},{1607, 600},
  {   0,   0}}
};
srec_t r_Looney = { .name = "Looney", .mel = {
  {   0,  52},{ 955, 428},{ 715, 212},{ 758, 212},{ 851, 212},{ 955, 212},{1136, 642},
  { 955, 212},{ 715, 212},{ 758, 212},{ 851, 212},{ 803, 212},{ 758, 642},{ 758, 212},
  { 758, 212},{ 955, 212},{ 851, 212},{ 955, 212},{ 758, 212},{ 955, 212},{ 851, 212},
  {1136, 212},{ 955, 212},{1275, 212},{1072, 212},{1136, 212},{1432, 212},
  {   0,   0}}
};
srec_t r_Muppets = { .name = "Muppets", .mel = {
  { 955, 240},{ 955, 240},{1136, 240},{1012, 240},{1136, 120},{1012, 240},{1275, 240},
  {   0, 240},{ 955, 240},{ 955, 240},{1136, 240},{1012, 120},{1136, 120},{   0, 120},
  {1275, 360},{   0, 240},{1517, 240},{1517, 240},{1275, 240},{1432, 240},{1517, 120},
  {1432, 240},{ 955, 120},{1912, 120},{1703, 120},{1517, 240},{1517, 120},{1517, 120},
  {   0, 120},{1517, 120},{1275, 240},{   0, 480},{ 955, 240},{ 955, 240},{1136, 240},
  {1012, 240},{1136, 120},{1012, 240},{1275, 240},{   0, 240},{ 955, 240},{ 955, 240},
  {1136, 240},{1012, 120},{1136, 240},{1275, 360},{   0, 240},{1517, 240},{1517, 240},
  {1275, 240},{1432, 240},{1517, 120},{1432, 240},{ 955, 120},{1912, 120},{1703, 120},
  {1517, 240},{1517, 120},{1703, 240},{1703, 120},{1912, 240},{   0,   0}}
};
srec_t r_Halloween = { .name = "Halloween", .mel = {
  { 851, 164},{1275, 164},{1275, 164},{ 851, 164},{1275, 164},{1275, 164},{ 851, 164},
  {1275, 164},{ 803, 164},{1275, 164},{ 851, 164},{1275, 164},{1275, 164},{ 851, 164},
  {1275, 164},{1275, 164},{ 851, 164},{1275, 164},{ 803, 164},{1275, 164},{ 901, 164},
  {1351, 164},{1351, 164},{ 901, 164},{1351, 164},{1351, 164},{ 901, 164},{1351, 164},
  { 851, 164},{1351, 164},{ 901, 164},{1351, 164},{1351, 164},{ 901, 164},{1351, 164},
  {1351, 164},{ 901, 164},{1351, 164},{ 851, 164},{1351, 164},{   0,   0}}
};
srec_t r_Careaboutus = { .name = "Careaboutus", .mel = {
  {1432, 120},{1517, 120},{1432, 120},{1517, 120},{1432, 120},{1517, 120},{1703, 240},
  {1517, 120},{1703, 120},{1517, 120},{1703, 120},{1517, 120},{1703, 120},{1912, 120},
  {1703, 120},{1703, 480},{   0,   0}}
};
srec_t r_TimeToSay = { .name = "TimeToSay", .mel = {
  {1912, 372},{1703, 184},{1517, 184},{1703, 184},{1517, 184},{1351, 184},{1275, 184},
  {1351, 184},{1275, 184},{1136, 184},{1275, 184},{1517, 184},{1136, 184},{1012, 184},
  { 955, 748},{1012, 748},{   0,   0}}
};
srec_t r_KnightRider = { .name = "KnightRider", .mel = {
  {1517, 120},{   0, 120},{1432, 120},{1517, 120},{1517, 120},{   0,   0}}
};
srec_t *collect[] = {
  &r_Peek, // 0
  &r_XFiles, // 1
  &r_Eternally, // 2
  &r_Batman, // 3
  &r_Simpsons, // 4
  &r_TheSimpsons, // 5
  &r_DasBoot, // 6
  &r_TakeOnMe, // 7
  &r_MissionImp, // 8
  &r_Et, // 9
  &r_Axelf, // 10
  &r_Hogans, // 11
  &r_PinkPanther, // 12
  &r_CountDown, // 13
  &r_AdamsFamily, // 14
  &r_Indiana, // 15
  &r_BarbieGirl, // 16
  &r_Entertainer, // 17
  &r_Autumn, // 18
  &r_Spring, // 19
  &r_Gadget, // 20
  &r_Looney, // 21
  &r_Muppets, // 22
  &r_Halloween, // 23
  &r_Careaboutus, // 24
  &r_TimeToSay, // 25
  &r_KnightRider, // 26
};

int sndGetSize()
{
	return ( sizeof( collect ) / sizeof( collect[0] ) );
}

char* sndGetName( uint8_t ind )
{
	if ( ind >= sndGetSize() ) {
		return NULL;
	}
	return collect[ind]->name;
}

// ************************************************************************************

melody_t *song = NULL;
volatile int ind_song = 0; // song index

#define COMPARE 10

/*
 * вызывается из main раз в 1 мс
 */
void sound(void)
{
	uint8_t event = 0;

	event = sndGetEv();
	if ( event == 0 ) {
		return;
	}
	if ( event & 0x80 ) {
		int numS = event & 0x07F;
		if ( numS >= sndGetSize() ) {
			return;
		}
		song = collect[numS]->mel;
		ind_song = 0;
		TIM_SetCounter( TIM17, 0 );
		TIM_SetCounter( TIM6, 0 );
		uint16_t per = song[0].period;
		if ( per == 0 ) {
			TIM_SetAutoreload( TIM17, 0xFFFF );
			TIM_SetCompare1( TIM17, 0 );
			TIM_SetAutoreload( TIM6, song[ind_song].delay );
		} else {
			TIM_SetAutoreload( TIM17, per );
			TIM_SetCompare1( TIM17, COMPARE );
			TIM_SetAutoreload( TIM6, song[ind_song].delay );
		}
		TIM_ITConfig( TIM6, TIM_IT_Update, ENABLE );
		TIM_Cmd( TIM17, ENABLE );
		TIM_Cmd( TIM6, ENABLE );
	} else {
		switch ( event ) {
		case SND_PERMIT:
			//canSound = 1;
			break;
		case SND_STOP:
			song = NULL;
			TIM_SetAutoreload( TIM17, 0xFFFF );
			TIM_SetCompare1( TIM17, 0 );
			TIM_Cmd( TIM17, DISABLE );
			TIM_Cmd( TIM6, DISABLE );
			TIM_ITConfig( TIM6, TIM_IT_Update, DISABLE );
			break;
		}
	}
}

int isPlaying( void )
{
	if ( song != NULL )
		return 1;
	else
		return 0;
}

/*
 * interrupt handler
 */
void TIM6_DAC_IRQHandler( void )
{
	if ( TIM_GetITStatus( TIM6, TIM_IT_Update ) == SET ) {
		TIM_ClearITPendingBit( TIM6, TIM_IT_Update );
		ind_song++;
		if ( song[ind_song].delay == 0 ) {
			song = NULL;
			TIM_SetAutoreload( TIM17, 0xFFFF );
			TIM_SetCompare1( TIM17, 0 );
			TIM_Cmd( TIM17, DISABLE );
			TIM_Cmd( TIM6, DISABLE );
			TIM_ITConfig( TIM6, TIM_IT_Update, DISABLE );
			return;
		}
		TIM_SetAutoreload( TIM6, song[ind_song].delay );
		TIM_SetCounter( TIM17, 0 );
		uint16_t per = song[ind_song].period;
		if ( per == 0 ) {
			TIM_SetAutoreload( TIM17, 0xFFFF );
			TIM_SetCompare1( TIM17, 0 );
		} else {
			TIM_SetAutoreload( TIM17, per );
			TIM_SetCompare1( TIM17, COMPARE );
		}
	}
}



